<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>매장 페이지</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
        #requests { margin-top:10px; }
        .req { border:1px solid #ddd; padding:8px; margin:4px 0; border-radius:6px; }
    </style>
</head>
<body>
<h2>매장 페이지</h2>

<button id="wsBtn" onclick="connectWS()" disabled>웹소켓 연결</button>
<p id="status">대기 중...</p>
<div id="requests"></div>

<script>
    const API = location.origin;
    let token = null;
    let storeId = null;
    let stompClient = null;

    function setStatus(msg){ document.getElementById('status').innerText = msg; }

    function bootstrap(){
        token = localStorage.getItem("ACCESS_TOKEN");
        storeId = localStorage.getItem("STORE_ID");
        const role = localStorage.getItem("ROLE");
        if(token && storeId && role === "STORE"){
            setStatus(`세션 복원: storeId=${storeId}`);
            document.getElementById('wsBtn').disabled = false;
        } else {
            setStatus("로그인 필요 → login.html로 이동하세요");
        }
    }

    function connectWS(){
        const sock = new SockJS(`${API}/ws`);
        stompClient = Stomp.over(sock);
        stompClient.connect({}, () => {
            const topic = `/topic/stores/${storeId}/requests`;
            stompClient.subscribe(topic, msg => {
                const data = JSON.parse(msg.body);
                addRequest(data);
            });
            setStatus("웹소켓 연결됨");
        });
    }

    function addRequest(req){
        const div = document.createElement("div");
        div.className = "req";
        div.innerHTML = `
      <b>요청 #${req.id}</b><br/>
      ${req.description} (${req.address})<br/>
      <button onclick="acceptRequest(${req.id})">수락</button>
    `;
        document.getElementById('requests').appendChild(div);
    }

    async function acceptRequest(requestId){
        const res = await fetch(`${API}/api/matching/requests/${requestId}/accept`, {
            method:"POST",
            headers:{ "Authorization":"Bearer " + token }
        });
        if(res.ok){
            setStatus(`요청 ${requestId} 수락 완료`);
        } else {
            setStatus(`요청 ${requestId} 수락 실패`);
        }
    }

    bootstrap();
</script>
</body>
</html>
