<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>사용자 페이지</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
        input { padding: 6px 8px; margin:2px; }
        button { padding: 6px 10px; margin:2px; }
        #log { white-space: pre-wrap; font-size: 12px; background:#f7f7f7; padding:8px; border-radius:8px; margin-top:10px; }
    </style>
</head>
<body>
<h2>사용자 페이지</h2>

<div>
    <input id="address" style="width:320px" placeholder="주소 (예: 서울시 성동구 성수동)" />
    <input id="description" style="width:240px" placeholder="설명" />
    <input id="radius" type="number" value="10" />
    <button id="reqBtn" onclick="createRequest()" disabled>수리요청 생성</button>
    <button id="wsBtn" onclick="connectWS()" disabled>웹소켓 연결</button>
</div>

<p id="status">대기 중...</p>
<div id="log"></div>

<script>
    const API = location.origin;
    let token = null;
    let userId = null;
    let stompClient = null;

    function setStatus(msg){ document.getElementById('status').innerText = msg; }
    function log(msg){ document.getElementById('log').textContent += msg + "\n"; }

    function bootstrap(){
        token = localStorage.getItem("ACCESS_TOKEN");
        userId = localStorage.getItem("USER_ID");
        const role = localStorage.getItem("ROLE");
        if(token && userId && role === "USER"){
            setStatus(`세션 복원: userId=${userId}`);
            document.getElementById('reqBtn').disabled = false;
            document.getElementById('wsBtn').disabled = false;
        } else {
            setStatus("로그인 필요 → login.html로 이동하세요");
        }
    }

    function connectWS(){
        const sock = new SockJS(`${API}/ws`);
        stompClient = Stomp.over(sock);
        stompClient.connect({}, () => {
            const topic = `/topic/users/${userId}/matched`;
            stompClient.subscribe(topic, msg => {
                const data = JSON.parse(msg.body);
                setStatus(`매칭 완료: ${data.matchedStoreName}(id=${data.matchedStoreId})`);
                log(`[수신] ${msg.body}`);
            });
            setStatus("웹소켓 연결됨");
        });
    }

    async function createRequest(){
        const body = {
            address: document.getElementById('address').value,
            description: document.getElementById('description').value,
            radius_km: Number(document.getElementById('radius').value),
            user_id: Number(userId)
        };
        const res = await fetch(`${API}/api/matching/requests`, {
            method:"POST",
            headers:{ "Content-Type":"application/json", "Authorization":"Bearer " + token },
            body: JSON.stringify(body)
        });
        if(res.ok){
            const j = await res.json();
            setStatus(`요청 생성: id=${j.id}`);
            log(`[요청 생성] ${JSON.stringify(j)}`);
        } else {
            setStatus("요청 실패");
        }
    }

    bootstrap();
</script>
</body>
</html>
